{% extends "base.html" %}

{% block title %}Lookup / Scan{% endblock %}
{% block page_title %}<i class="fas fa-search"></i> Lookup / Scan{% endblock %}

{% block content %}
<div class="card">
  <p class="text-muted mb-2">
    Enter one or more serial numbers, log numbers, or sticker IDs — separated by commas or newlines.
    Scan barcodes directly into the field on iPad.
  </p>

  <div class="lookup-input-area">
    <textarea id="lookupInput" class="form-control" rows="3"
              placeholder="Enter serial #, log #, or sticker ID…&#10;Scan barcode here…&#10;Separate multiple with commas or newlines"></textarea>
    <div style="display:flex;flex-direction:column;gap:.5rem;">
      <button class="btn btn-primary" onclick="doLookup()"><i class="fas fa-search"></i> Search</button>
      <button class="btn btn-secondary" onclick="clearLookup()"><i class="fas fa-times"></i> Clear</button>
    </div>
  </div>
</div>

<div id="lookupResults" class="lookup-results"></div>

<script>
async function doLookup() {
  const input = document.getElementById('lookupInput').value.trim();
  if (!input) return;
  const queries = input.split(/[,\n]+/).map(s => s.trim()).filter(Boolean);
  const res = await fetch('/api/lookup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ queries })
  });
  const data = await res.json();
  const container = document.getElementById('lookupResults');
  container.innerHTML = '';

  data.forEach(group => {
    const div = document.createElement('div');
    div.className = 'result-group card';
    let html = '<h3><i class="fas fa-search"></i> "' + group.query + '" — ';
    if (group.matches.length === 0) {
      html += '<span class="text-danger">No matches</span></h3>';
    } else {
      html += group.matches.length + ' match(es)</h3>';
      html += '<div class="table-wrap"><table><thead><tr><th>Log #</th><th>Name</th><th>S/N</th><th>Status</th><th>Next Cal.</th><th></th></tr></thead><tbody>';
      group.matches.forEach(t => {
        html += '<tr>';
        html += '<td><strong>' + t.log_number + '</strong></td>';
        html += '<td><a href="/tools/' + t.id + '">' + t.name + '</a></td>';
        html += '<td>' + t.serial_number + '</td>';
        html += '<td><span class="badge badge-' + t.status + '">' + t.status.replace(/_/g,' ') + '</span></td>';
        html += '<td>' + (t.next_calibration_date || '—') + '</td>';
        html += '<td><a href="/tools/' + t.id + '" class="btn btn-primary btn-sm"><i class="fas fa-eye"></i></a></td>';
        html += '</tr>';
      });
      html += '</tbody></table></div>';
    }
    div.innerHTML = html;
    container.appendChild(div);
  });
}

function clearLookup() {
  document.getElementById('lookupInput').value = '';
  document.getElementById('lookupResults').innerHTML = '';
}

// Auto-search on Enter
document.getElementById('lookupInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); doLookup(); }
});
</script>
{% endblock %}
