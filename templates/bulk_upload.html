{% extends "base.html" %}

{% block title %}Bulk Upload{% endblock %}
{% block page_title %}
  <i class="fas fa-cloud-upload-alt"></i> Bulk Upload Certificates
{% endblock %}

{% block content %}

<!-- ── Upload Area ─────────────────────────────────────────────── -->
{% if not processed %}
<div class="card">
  <div class="card-header">
    <h2>Upload Calibration PDFs</h2>
  </div>
  <p style="color:var(--c-text-lt);margin-bottom:1.25rem;font-size:.92rem;">
    Drop multiple PDF calibration certificates here. The system will extract serial numbers, asset IDs,
    and certificate numbers from each PDF and automatically link them to matching tools.
  </p>

  <form method="post" enctype="multipart/form-data" id="bulkUploadForm">
    <div class="drop-zone" id="dropZone">
      <i class="fas fa-cloud-upload-alt" style="font-size:2.5rem;opacity:.4;margin-bottom:.75rem;display:block;"></i>
      <p style="font-weight:700;font-size:1.05rem;margin-bottom:.35rem;">Drag & drop PDF files here</p>
      <p style="color:var(--c-text-lt);font-size:.85rem;">or click to browse</p>
      <input type="file" name="files" id="fileInput" multiple accept=".pdf,.png,.jpg,.jpeg,.doc,.docx" style="display:none;">
    </div>

    <div id="fileList" class="file-list" style="display:none;">
      <h3 style="font-size:.85rem;font-weight:700;color:var(--c-muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:.5rem;">
        Selected Files
      </h3>
      <ul id="fileListItems"></ul>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
        <i class="fas fa-upload"></i> Upload & Auto-Match
      </button>
      <button type="button" class="btn btn-secondary" id="clearBtn" style="display:none;">
        <i class="fas fa-times"></i> Clear
      </button>
    </div>
  </form>
</div>

<div class="card">
  <div class="card-header">
    <h2>How Auto-Matching Works</h2>
  </div>
  <div style="color:var(--c-text-lt);font-size:.9rem;line-height:1.7;">
    <p><strong>1.</strong> Each PDF is scanned for text — serial numbers, certificate numbers, asset IDs, and model numbers are extracted.</p>
    <p><strong>2.</strong> The filename is also parsed (e.g. <code style="background:var(--c-surface-2);padding:.15rem .4rem;border-radius:4px;font-size:.82rem;">CTR_1124667-1ME_Floor Scale_2256.pdf</code>).</p>
    <p><strong>3.</strong> Extracted identifiers are compared against every tool's serial number, log number, sticker ID, and model number.</p>
    <p><strong>4.</strong> Matched PDFs are automatically attached to the tool. Unmatched files can be manually linked.</p>
  </div>
</div>
{% endif %}

<!-- ── Results ─────────────────────────────────────────────────── -->
{% if processed %}
<div class="card">
  <div class="card-header">
    <h2>Upload Results</h2>
    <a href="{{ url_for('bulk_upload') }}" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Upload More</a>
  </div>

  {% set matched = results|selectattr('status', 'equalto', 'matched')|list %}
  {% set unmatched = results|selectattr('status', 'equalto', 'unmatched')|list %}
  {% set skipped = results|selectattr('status', 'equalto', 'skipped')|list %}

  <!-- Summary row -->
  <div class="stats-row" style="margin-bottom:1.5rem;">
    <div class="stat-card stat-total">
      <div class="stat-icon"><i class="fas fa-file-pdf"></i></div>
      <div class="stat-number">{{ results|length }}</div>
      <div class="stat-label">Total Files</div>
    </div>
    <div class="stat-card stat-good">
      <div class="stat-icon"><i class="fas fa-link"></i></div>
      <div class="stat-number">{{ matched|length }}</div>
      <div class="stat-label">Auto-Matched</div>
    </div>
    <div class="stat-card stat-warn">
      <div class="stat-icon"><i class="fas fa-question-circle"></i></div>
      <div class="stat-number">{{ unmatched|length }}</div>
      <div class="stat-label">Unmatched</div>
    </div>
    <div class="stat-card stat-bad">
      <div class="stat-icon"><i class="fas fa-ban"></i></div>
      <div class="stat-number">{{ skipped|length }}</div>
      <div class="stat-label">Skipped</div>
    </div>
  </div>

  <!-- Matched files -->
  {% if matched %}
  <h3 style="font-size:.9rem;font-weight:700;color:var(--c-success);margin-bottom:.75rem;text-transform:uppercase;letter-spacing:.05em;">
    <i class="fas fa-check-circle"></i> Auto-Matched
  </h3>
  <div class="table-wrap" style="margin-bottom:1.5rem;">
    <table>
      <thead>
        <tr>
          <th>PDF File</th>
          <th>Linked Tool</th>
          <th>Matched On</th>
          <th>Value</th>
          <th>View</th>
        </tr>
      </thead>
      <tbody>
        {% for r in matched %}
          {% for m in r.matches %}
          <tr>
            <td><i class="fas fa-file-pdf" style="color:#ef4444;margin-right:.35rem;"></i> {{ r.filename }}</td>
            <td><strong>{{ m.tool_name }}</strong></td>
            <td><span class="badge badge-active">{{ m.match_field|replace('_',' ') }}</span></td>
            <td class="text-sm">{{ m.match_value }}</td>
            <td><a href="{{ url_for('tool_detail', tool_id=m.tool_id) }}" class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i></a></td>
          </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- Unmatched files -->
  {% if unmatched %}
  <h3 style="font-size:.9rem;font-weight:700;color:var(--c-warning);margin-bottom:.75rem;text-transform:uppercase;letter-spacing:.05em;">
    <i class="fas fa-question-circle"></i> Unmatched — Manual Link
  </h3>
  {% for r in unmatched %}
  <div class="card" style="background:var(--c-bg-subtle);padding:1rem 1.25rem;margin-bottom:.75rem;">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;">
      <div>
        <strong><i class="fas fa-file-pdf" style="color:#ef4444;margin-right:.35rem;"></i> {{ r.filename }}</strong>
        {% if r.identifiers %}
        <div style="margin-top:.35rem;">
          <span class="text-sm text-muted">Extracted:</span>
          {% for ident in r.identifiers[:8] %}
          <span class="badge badge-backup" style="margin:.1rem;">{{ ident }}</span>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      <form method="post" action="{{ url_for('bulk_upload_link') }}" style="display:flex;gap:.5rem;align-items:center;">
        <input type="hidden" name="stored_filename" value="{{ r.stored }}">
        <input type="hidden" name="original_filename" value="{{ r.filename }}">
        <select name="tool_id" class="form-control" style="width:250px;font-size:.85rem;padding:.4rem .6rem;" required>
          <option value="">Select tool...</option>
          {% for tool in all_tools %}
          <option value="{{ tool.id }}">{{ tool.log_number }} — {{ tool.name }} ({{ tool.serial_number }})</option>
          {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-link"></i> Link</button>
      </form>
    </div>
  </div>
  {% endfor %}
  {% endif %}

  {% if skipped %}
  <h3 style="font-size:.9rem;font-weight:700;color:var(--c-danger);margin-bottom:.75rem;text-transform:uppercase;letter-spacing:.05em;">
    <i class="fas fa-ban"></i> Skipped
  </h3>
  {% for r in skipped %}
  <p class="text-sm text-muted"><i class="fas fa-file"></i> {{ r.filename }} — {{ r.reason }}</p>
  {% endfor %}
  {% endif %}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const fileList = document.getElementById('fileList');
  const fileListItems = document.getElementById('fileListItems');
  const uploadBtn = document.getElementById('uploadBtn');
  const clearBtn = document.getElementById('clearBtn');

  if (!dropZone) return;

  // Click to browse
  dropZone.addEventListener('click', () => fileInput.click());

  // Drag events
  ['dragenter','dragover'].forEach(evt => {
    dropZone.addEventListener(evt, e => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
  });
  ['dragleave','drop'].forEach(evt => {
    dropZone.addEventListener(evt, e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
    });
  });

  dropZone.addEventListener('drop', e => {
    fileInput.files = e.dataTransfer.files;
    updateFileList();
  });

  fileInput.addEventListener('change', updateFileList);

  clearBtn.addEventListener('click', () => {
    fileInput.value = '';
    fileList.style.display = 'none';
    uploadBtn.disabled = true;
    clearBtn.style.display = 'none';
  });

  function updateFileList() {
    const files = fileInput.files;
    if (files.length === 0) return;

    fileListItems.innerHTML = '';
    for (const f of files) {
      const li = document.createElement('li');
      li.innerHTML = `<i class="fas fa-file-pdf" style="color:#ef4444;margin-right:.4rem;"></i> ${f.name} <span class="text-muted text-sm">(${(f.size/1024).toFixed(0)} KB)</span>`;
      fileListItems.appendChild(li);
    }
    fileList.style.display = 'block';
    uploadBtn.disabled = false;
    clearBtn.style.display = 'inline-flex';
  }

  // Show loading state on submit
  document.getElementById('bulkUploadForm').addEventListener('submit', () => {
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
  });
});
</script>
{% endblock %}
